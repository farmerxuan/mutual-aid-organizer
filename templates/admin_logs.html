{% extends 'layout.html' %}
{% block body %}
<div class="container mt-4">
  <h2>Export Logs</h2>
  <form id="logsFilterForm" class="row g-3 align-items-end">
    <div class="col-auto">
      <label class="form-label">User</label>
      <input type="text" id="filterUser" class="form-control" placeholder="username">
    </div>
    <div class="col-auto">
      <label class="form-label">Start (ISO)</label>
      <input type="datetime-local" id="filterStart" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label">End (ISO)</label>
      <input type="datetime-local" id="filterEnd" class="form-control">
    </div>
    <div class="col-auto">
      <button type="button" id="applyFilters" class="btn btn-primary">Apply</button>
    </div>
    <div class="col-auto">
      <button type="button" id="exportCsvBtn" class="btn btn-outline-danger">Export CSV</button>
    </div>
  </form>

  <div class="mt-3">
    <table class="table table-sm" id="logsTable">
      <thead>
        <tr><th>ID</th><th>User</th><th>Action</th><th>Rows</th><th>When</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <nav>
      <ul class="pagination" id="logsPager"></ul>
    </nav>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const perPage = 25;
  let page = 1;
  function isoLocal(dt){
    if(!dt) return '';
    const d = new Date(dt);
    return d.toLocaleString();
  }
  async function load(pageNum){
    page = pageNum || 1;
    const user = document.getElementById('filterUser').value || '';
    const start = document.getElementById('filterStart').value || '';
    const end = document.getElementById('filterEnd').value || '';
    const params = new URLSearchParams({page: page, per_page: perPage});
    if(user) params.append('user', user);
    if(start) params.append('start', new Date(start).toISOString());
    if(end) params.append('end', new Date(end).toISOString());
    const res = await apiGet('/admin/export-logs?' + params.toString());
    const tbody = document.querySelector('#logsTable tbody');
    tbody.innerHTML = '';
    res.items.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.id}</td><td>${escapeHtml(it.username)}</td><td>${escapeHtml(it.action)}</td><td>${it.rows}</td><td>${escapeHtml(it.created_at)}</td>`;
      tbody.appendChild(tr);
    });
    renderPager(res.total, res.page, res.per_page);
  }
  function renderPager(total, curPage, perPage){
    const pages = Math.max(1, Math.ceil(total / perPage));
    const ul = document.getElementById('logsPager');
    ul.innerHTML = '';
    for(let i=1;i<=pages;i++){
      const li = document.createElement('li');
      li.className = 'page-item' + (i===curPage? ' active':'');
      li.innerHTML = `<a class='page-link' href='#'>${i}</a>`;
      li.addEventListener('click', (e)=>{e.preventDefault(); load(i)});
      ul.appendChild(li);
    }
  }
  document.getElementById('applyFilters').addEventListener('click', ()=>load(1));
  document.getElementById('exportCsvBtn').addEventListener('click', async ()=>{
    if(!confirm('Export logs as CSV? This will be recorded.')) return;
    const user = document.getElementById('filterUser').value || '';
    const start = document.getElementById('filterStart').value || '';
    const end = document.getElementById('filterEnd').value || '';
    const body = {confirm: true};
    if(user) body.user = user;
    if(start) body.start = new Date(start).toISOString();
    if(end) body.end = new Date(end).toISOString();
    const csv = await apiPost('/admin/export-logs/csv', body, {raw:true});
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'export_logs.csv'; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showToast('CSV exported');
    load(page);
  });
  load(1);
});
</script>

{% endblock %}
